import telebot
import openai
import random

# Установите ваш API-ключ OpenAI
openai.api_key = "YOUR_OPENAI_API_KEY"

# Установите ваш токен телеграм-бота
telegram_token = "YOUR_TELEGRAM_BOT_API"

bot = telebot.TeleBot(telegram_token)

user_topics = {}

user_dialog_context = {}

@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.chat.id
    bot.send_message(user_id, "Привет! Я ваш личный бот-ассистент спрашивайте все что угодно!")

@bot.message_handler(commands=['topic'])
def change_topic(message):
    user_id = message.chat.id
    user_topics[user_id] = message.text.split(' ', 1)[1]
    bot.send_message(user_id, f"Тема разговора изменена на: {user_topics[user_id]}")

@bot.message_handler(commands=['end'])
def end_conversation(message):
    user_id = message.chat.id
    user_topics.pop(user_id, None)
    user_dialog_context.pop(user_id, None)
    bot.send_message(user_id, "Диалог завершён. Вы можете начать новую тему с помощью команды /topic")

@bot.message_handler(commands=['help'])
def show_help(message):
    help_message = (
        "/start - начать разговор с ботом\n"
        "/topic [тема] - установить тему разговора\n"
        "/end - завершить текущий разговор\n"
        "/help - показать это сообщение\n"
        "/joke - отправляет шутку\n"
        "/fact - отправляет интересный факт"

    )
    bot.send_message(message.chat.id, help_message)

@bot.message_handler(commands=['fact'])
def send_fact(message):
    user_id = message.chat.id
    facts = [
        "Медведи могут плавать.",
        "Слоны – крупнейшие сухопутные животные.",
        "Морские черепахи могут дышать через задний проход.",
        "Волки очень социальные животные и живут в стаи.",
        "Пчелы не спят."
        "Океаны занимают около 70% поверхности Земли."
        "Коалы спят в среднем 18 часов в день."
        "Пчелы могут распознавать лица."
        "Гиппопотамы могут бегать быстрее, чем человек."
        "Слоны могут слышать инфразвук, который человек не способен услышать."
        "Дельфины могут узнавать себя в зеркале."
        "Камбала при рождении имеет один глаз на каждой стороне тела."
        "Медведи-панды сами выбирают партнеров для размножения."
        "Бабочки могут вкусить пищу ногами."
        "Орехи и мозги имеют схожую структуру, что может указывать на пользу орехов для мозга."
        "Медведи левшами или правшами не рождаются, но со временем развивают предпочтение к одной из лап."
        "Акулы могут обнаруживать электромагнитные поля, создаваемые живыми организмами."
        "Крокодилы не могут высовывать язык."
        "Слон может впадать в состояние горячки."
        "Пчелы могут танцевать, чтобы коммуницировать с другими пчелами о местоположении пищи."
        "Пауки являются хищниками, но питаются также своей добычей."
        "Колибри – единственная птица, которая может летать задом наперед."
        "Медведи способны угадать пол ребенка в животе женщины."
        "Хамелеоны могут двигать глазами независимо друг от друга."
        "Коровы могут лечиться с помощью музыки."
        "Голубые киты — самые большие существа на Земле, когда-либо существовавшие."
        "Пауки производят шелк для создания паутин, но также могут создавать шелковые коконы для яиц."
        "Опоссумы не могут прокусить большой палец ноги."
        "Свиньи могут быть учебно более способными, чем собаки, и могут учиться командам так же, как и обученные дельфины."
        "Лошади имеют большие глаза, чем любое другое наземное животное."
        "Орлы способны поворачивать голову на 270 градусов."
        "Зебры имеют черные тела с белыми полосами, а не наоборот."
        "Кенгуру не может двигаться задом наперед."
        "Пингвины могут отличать аналоговое и цифровое изображения."
        "Внутренние органы крокодилов ориентированы так, что они могут дышать, держа только голову на поверхности воды."
        "Дельфины способны спать наполовину, чтобы мозг мог оставаться в бодрствующем состоянии."
        "Кошки способны создавать более 100 разных звуков."
        "Медведи-полары могут плавать на расстояние до 60 миль (96 км) в поисках пищи."
        "Слон может поднимать вес, восемь раз больший своего веса."
        "Медузы не имеют сердца, но имеют желудок и нервную систему."
        "Виноград можно использовать для производства перьев."
        "Черепахи могут дышать через задний проход."
        "Ленивцы могут спать более 15 часов в день."
        "Белки могут запоминать тысячи мест, где они спрятали орехи."
        "Красные панды не являются родственниками панд."
        "Волки могут жить в стае, состоящей из более чем 30 членов."
        "В некоторых странах кенгуру рассматриваются как вредители из-за их привычки питаться сельскохозяйственными культурами."
        "У дельфинов есть свои уникальные именины: они могут отвечать на конкретные звуки и свисты, соответствующие их имени."
        "Крокодилы могут пребывать в состоянии практически анабиоза, выживая без пищи и воды в течение длительных периодов времени."
        "Звуки, издаваемые жирафами, нельзя услышать человеческим ухом, так как они находятся за пределами диапазона слышимости."
        "Октопусы обладают тремя сердцами: два для циркуляции крови в органы, а одно для циркуляции крови в жабры."
    ]
    random_fact = random.choice(facts)
    bot.send_message(user_id, random_fact)

@bot.message_handler(commands=['joke'])
def send_joke(message):
    user_id = message.chat.id
    jokes = [
        "Почему компьютеры так плохо играют в футбол? Потому что каждый раз, когда они принимают пас, они потеряются.",
        "Какой самый частый вопрос, который задают в лифте? Какая кнопка нажата чаще всего.",
        "Что говорит программист, когда он находит свободную минуту? Подождите, я все-таки помню, как это работает."
        "Почему программисты так плохо на ужине? Потому что они все время ищут хаки!"
        "Почему баран стоит на вершине горы? Потому что он не может подняться вниз!"
        "Почему книги такие хорошие друзья? Потому что они всегда обложены!"
        "Как называется медведь без зубов? Гладиатор!"
        "Почему грибы на вечеринке всегда самые интересные? Потому что они грибные рассказчики!"
        "Почему мороженое всегда спокойное? Потому что оно знает, как охладить горячие ситуации!"
        "Какой инструмент любим у мебельщиков-вампиров? Виниловая пила!"
        "Почему календарю так нравится вечеринка? Потому что у него есть много дат!"
        "Почему доллар такой неверный? Потому что он всегда сбегает!"
        "Почему телефоны так несчастливы? Потому что их всегда тыкают в лицо!"
        "Почему стаканчик всегда в хорошем настроении? Потому что у него всегда наполняющие впечатления!"
        "Почему ручка стала красной? Потому что ей стало стыдно быть в черной молчанке!"
        "Почему батарея такая грустная? Потому что она всегда упадет, когда ты меньше всего этого ждешь!"
        "Почему печенье всегда на уровне? Потому что оно знает, что оно крошечная радость!"
        "Почему сумка всегда такая легкая? Потому что она держит все свои веселые секреты!"
        "Почему буква А всегда такая важная? Потому что она начинает слова!"
        "Почему часы всегда так сосредоточены? Потому что время деньги!"
        "Почему зубы всегда веселятся? Потому что они живут в рту!"
        "Почему бумага всегда нервничает? Потому что она всегда в плену!"
        "Почему куртка всегда заботливая? Потому что она всегда готова обнять вас!"
        "Почему лампочка всегда на свету? Потому что она всегда включена в дело!"
        "Почему календарь всегда волнуется? Потому что у него много дат!"
        "Почему морковка всегда улыбается? Потому что она знает, как быть здоровой!"
        "Почему котел всегда страшноват? Потому что у него есть кипяченая натура!"
        "Почему карандаш всегда дружелюбен? Потому что он всегда рисует улыбки!"
        "Почему стул всегда такой молчаливый? Потому что он не может поддержать разговор!"
        "Почему чайник всегда на грани? Потому что он готов вскипеть от любого момента!"
        "Почему дрова всегда такие прямые? Потому что они не согнутся от усилий!"
        "Почему телефон всегда такой интересный? Потому что у него есть много звонков!"
        "Почему холодильник всегда так уверен? Потому что он знает, что в нем все остынет!"
        "Почему картина всегда загадочна? Потому что она скрывает много внутренних миров!"
        "Почему замок всегда такой загадочный? Потому что он скрывает ключевые секреты!"
        "Почему дверь всегда сдержанная? Потому что она знает, как открываться в нужное время!"
        "Почему кровать всегда на грани? Потому что она готова вас унести сонными волнами!"
        "Почему галстук всегда такой аккуратный? Потому что он знает, как завязать деловые отношения!"
        "Почему зонтик всегда готов? Потому что он всегда настороже, когда надвигается дождь!"
        "Почему книга всегда хорошая? Потому что она имеет красивую обложку!"
        "Почему пицца всегда разнообразна? Потому что в ней много слоев интересов!"
        "Почему мышь всегда дружелюбна? Потому что она всегда ищет общий язык!"
        "Почему собака всегда такая заботливая? Потому что она готова всегда лечить ваше настроение!"
        "Почему гитара всегда музыкальная? Потому что она готова завести приятные аккорды!"
        "Почему маятник всегда двигается? Потому что он ищет баланс в жизни!"
        "Почему часы всегда знают время? Потому что они всегда смотрят в будущее!"
        "Почему плюшевый мишка всегда такой милый? Потому что он создан для объятий!"
        "Почему молоток всегда уверен? Потому что он готов бить в цель!"
        "Почему солнце всегда светит? Потому что оно знает, как поднять настроение!"
        "Почему компьютер всегда такой умный? Потому что в нем много битов интереса!"
        "Почему батут всегда радует? Потому что он всегда приподнимает настроение!"
        "Почему пирожное всегда веселое? Потому что оно знает, как вкусно провести время!"
    ]
    random_joke = random.choice(jokes)
    bot.send_message(user_id, random_joke)

@bot.message_handler(func=lambda message: True)
def reply(message):
    user_id = message.chat.id
    user_input = message.text

    if user_id in user_topics:
        user_input = f"Тема: {user_topics[user_id]}\nПользователь: {user_input}"

    if user_id in user_dialog_context:
        user_input = f"{user_dialog_context[user_id]}\nПользователь: {user_input}"

    response = openai.Completion.create(
        engine="text-davinci-003",
        prompt=user_input,
        max_tokens=4000
    )

    bot_reply = response.choices[0].text.strip()
    bot.send_message(user_id, bot_reply)

if __name__ == '__main__':
    bot.polling()
